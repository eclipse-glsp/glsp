name: Prepare Release

on:
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release type (major, minor, patch, next, or custom)'
        required: true
        type: choice
        options:
          - major
          - minor
          - patch
          - next
          - custom
      custom_version:
        description: 'Custom version (required if release_type is custom)'
        required: false
        type: string
      release_repo:
        description: 'GLSP repository to release'
        required: true
        type: choice
        options:
          - glsp
          - glsp-client
          - glsp-theia-integration
          - glsp-server
          - glsp-server-node
          - glsp-eclipse-integration
          - glsp-vscode-integration
          - glsp-playwright
      branch:
        description: 'Branch to use for the release repo (default: default branch)'
        required: false
        type: string
      draft:
        description: 'Create PR as draft'
        required: false
        type: boolean
        default: false
  workflow_call:
    inputs:
      release_type:
        description: 'Release type (major, minor, patch, next, or custom)'
        required: true
        type: string
      custom_version:
        description: 'Custom version (required if release_type is custom)'
        required: false
        type: string
      release_repo:
        description: 'GLSP repository to release'
        required: true
        type: string
      branch:
        description: 'Branch to use for the release repo (default: default branch)'
        required: false
        type: string
      draft:
        description: 'Create PR as draft'
        required: false
        type: boolean
        default: false

jobs:
  release:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout release helper repo (@eclipse-glsp/glsp)
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          repository: eclipse-glsp/glsp
          path: glsp-release-helper
          ref: master

      - name: Checkout release repo (${{ inputs.release_repo || github.event.inputs.release_repo }})
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          repository: eclipse-glsp/${{ inputs.release_repo || github.event.inputs.release_repo }}
          path: release-repo
          ref: ${{ inputs.branch || github.event.inputs.branch }}

      - name: Set up Node.js
        uses: actions/setup-node@a0853c24544627f65ddf259abe73b1d18a591444 # v5.0.0
        with:
          node-version: 20

      - name: Set up Java 21
        if: >-
          (inputs.release_repo || github.event.inputs.release_repo) == 'glsp-server' ||
          (inputs.release_repo || github.event.inputs.release_repo) == 'glsp-eclipse-integration'
        uses: actions/setup-java@dded0888837ed1f317902acf8a20df0ad188d165 # v5.0.0
        with:
          distribution: temurin
          java-version: '21'

      - name: Set up Python
        if: (inputs.release_repo || github.event.inputs.release_repo) == 'glsp-theia-integration'
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: '3.11'

      - name: Install Yarn
        run: npm install -g yarn

      - name: Install dependencies in glsp-release-helper
        working-directory: ./glsp-release-helper
        run: yarn install

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Prepare release
        id: prepare_release
        working-directory: ./glsp-release-helper
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DRAFT_FLAG=""
          if [[ "${{ inputs.draft || github.event.inputs.draft }}" == "true" ]]; then
            DRAFT_FLAG="-d"
          fi

          if [[ "${{ inputs.release_type || github.event.inputs.release_type }}" == "custom" ]]; then
            yarn glsp releng prepare custom "${{ inputs.custom_version || github.event.inputs.custom_version }}" -r ${{ github.workspace }}/release-repo $DRAFT_FLAG
          else
            yarn glsp releng prepare "${{ inputs.release_type || github.event.inputs.release_type }}" -r ${{ github.workspace }}/release-repo $DRAFT_FLAG
          fi
